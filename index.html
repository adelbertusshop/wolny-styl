<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kalendarz (Miesiąc / Tydzień / Dzień)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --cal-hour-height: 56px;
      --cal-gutter: 56px;
      --cal-day-min-width: 180px;
    }

    html { -webkit-text-size-adjust: 100%; }

    .thin-scroll::-webkit-scrollbar{ height: 10px; width: 10px; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: rgba(100,116,139,.35); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-track{ background: transparent; }

    .time-grid { position: relative; }
    .time-grid::before{ 
      content:""; position:absolute; left:0; right:0; top:0; bottom:0;
      background-image: linear-gradient(to bottom, rgba(148,163,184,.35) 1px, transparent 1px);
      background-size: 100% calc(var(--cal-hour-height)/2);
      pointer-events:none;
    }

    .now-line{ position:absolute; left:0; right:0; height:2px; background:#ef4444; z-index:30; }
    .now-dot{ position:absolute; left: calc(var(--cal-gutter) - 6px); width:10px; height:10px; border-radius:999px; background:#ef4444; transform: translate(-50%, -50%); z-index:31; }

    .event{ 
      position:absolute; border-radius: 10px; padding: 6px 8px; font-size: 12px; line-height: 1.1;
      overflow:hidden; cursor: grab; user-select:none; box-shadow: 0 1px 2px rgba(0,0,0,.08);
    }
    .event:active{ cursor: grabbing; }

    .event .title{ font-weight: 600; font-size: 12px; }
    .event .meta{ opacity: .9; font-size: 11px; }

    .resize-handle{ position:absolute; left:0; right:0; height:10px; bottom:-2px; cursor: ns-resize; opacity:.0; }
    .event:hover .resize-handle{ opacity:.15; }

    .ghost{ 
      position:absolute; border-radius: 10px; background: rgba(59,130,246,.18); 
      border: 1px dashed rgba(59,130,246,.6); z-index: 40; pointer-events:none;
    }

    .month-cell{ position:relative; min-height: 110px; }
    .month-events{ display:flex; flex-direction:column; gap:6px; padding-top: 26px; }
    .month-pill{ font-size: 11px; padding: 4px 6px; border-radius: 999px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }

    .kbd{ 
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px; padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(148,163,184,.5);
      background: rgba(248,250,252,.8);
    }

    .no-select, .no-select * { user-select: none !important; }

    .allday-event { 
      position: absolute; top: 2px; left: 6px; right: 6px; height: 24px; 
      border-radius: 6px; padding: 2px 8px; font-size: 11px; z-index: 20;
    }

    @media (max-width: 900px){
      :root{ --cal-hour-height: 52px; --cal-gutter: 50px; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="min-h-dvh flex flex-col">
    <!-- Górny pasek -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-slate-200">
      <div class="max-w-[1400px] mx-auto px-4 py-3 flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 text-white grid place-items-center font-bold">K</div>
          <div>
            <div class="font-semibold leading-tight">Kalendarz</div>
            <div class="text-xs text-slate-500 leading-tight">Miesiąc / Tydzień / Dzień • przeciągnij aby utworzyć</div>
          </div>
        </div>

        <div class="flex-1"></div>

        <div class="flex items-center gap-2">
          <button id="prevBtn" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">◀</button>
          <button id="todayBtn" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">Dzisiaj</button>
          <button id="nextBtn" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">▶</button>
          <div class="w-px h-8 bg-slate-200 mx-1"></div>
          <div class="text-sm font-semibold" id="rangeLabel">—</div>
        </div>

        <div class="flex-1"></div>

        <div class="flex items-center gap-2">
          <div class="hidden md:flex items-center gap-2 text-xs text-slate-500">
            <span class="kbd">Przeciągnij</span> utwórz • <span class="kbd">Esc</span> anuluj • <span class="kbd">⌫</span> usuń
          </div>
          <div class="w-px h-8 bg-slate-200 mx-1 hidden md:block"></div>
          <div class="inline-flex rounded-xl border border-slate-200 bg-white overflow-hidden">
            <button data-view="month" class="viewBtn px-3 py-2 text-sm hover:bg-slate-50">Miesiąc</button>
            <button data-view="week" class="viewBtn px-3 py-2 text-sm hover:bg-slate-50">Tydzień</button>
            <button data-view="day" class="viewBtn px-3 py-2 text-sm hover:bg-slate-50">Dzień</button>
            <button data-view="list" class="viewBtn px-3 py-2 text-sm hover:bg-slate-50">Lista</button>
          </div>
          <button id="newBtn" class="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm">+ Nowe</button>
        </div>
      </div>
    </header>

    <!-- Główna zawartość -->
    <main class="flex-1 max-w-[1400px] mx-auto w-full px-4 py-4">
      <div class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-4">
        <!-- Panel boczny -->
        <aside class="lg:sticky lg:top-[76px] self-start">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
            <div class="flex items-center justify-between">
              <div class="font-semibold">Kategorie</div>
              <button id="resetFilters" class="text-xs text-slate-600 hover:text-slate-900">Resetuj</button>
            </div>
            <div class="mt-3 space-y-2" id="categoryList"></div>

            <div class="mt-4 pt-4 border-t border-slate-200">
              <div class="font-semibold">Szybkie dodawanie</div>
              <div class="mt-2 grid grid-cols-1 gap-2">
                <input id="quickTitle" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Tytuł" />
                <div class="grid grid-cols-2 gap-2">
                  <input id="quickDate" type="date" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" />
                  <input id="quickTime" type="time" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" />
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <select id="quickCategory" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200"></select>
                  <select id="quickType" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200">
                    <option value="timed">Z godzinami</option>
                    <option value="allday">Całodniowe</option>
                  </select>
                </div>
                <button id="quickAddBtn" class="px-3 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm">Dodaj</button>
                <div class="text-xs text-slate-500">Widok Tydzień/Dzień: przeciągnij na siatce aby utworzyć.</div>
              </div>
            </div>
          </div>

          <div class="mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
            <div class="font-semibold">Wybrane wydarzenie</div>
            <div id="inspectorEmpty" class="mt-2 text-sm text-slate-500">Kliknij wydarzenie aby edytować.</div>
            <div id="inspector" class="mt-3 hidden">
              <div class="space-y-2">
                <input id="insTitle" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" />
                <div class="grid grid-cols-2 gap-2">
                  <input id="insDate" type="date" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" />
                  <select id="insType" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200">
                    <option value="timed">Z godzinami</option>
                    <option value="allday">Całodniowe</option>
                  </select>
                </div>
                <div id="timeFields" class="grid grid-cols-2 gap-2">
                  <input id="insStart" type="time" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" />
                  <input id="insEnd" type="time" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" />
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <select id="insCategory" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200"></select>
                  <select id="insRepeat" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200">
                    <option value="none">Nie powtarzaj</option>
                    <option value="daily">Codziennie</option>
                    <option value="weekly">Co tydzień</option>
                  </select>
                </div>
                <textarea id="insNotes" rows="3" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Notatki"></textarea>
                <div class="flex items-center justify-between gap-2 pt-1">
                  <button id="deleteBtn" class="px-3 py-2 rounded-xl border border-rose-200 bg-rose-50 hover:bg-rose-100 text-rose-700 text-sm">Usuń</button>
                  <button id="saveBtn" class="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm">Zapisz</button>
                </div>
                <div class="text-xs text-slate-500">Przeciągaj aby przenieść. Za dolną krawędź aby zmienić czas.</div>
              </div>
            </div>
          </div>

          <!-- Wyszukiwarka -->
          <div class="mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
            <div class="font-semibold">Wyszukiwanie</div>
            <input id="searchInput" type="text" class="mt-2 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Szukaj wydarzeń..." />
            <div id="searchResults" class="mt-2 space-y-2 max-h-60 overflow-y-auto"></div>
          </div>
        </aside>

        <!-- Kalendarz -->
        <section class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
          <div id="calendarRoot" class="min-h-[720px]"></div>
        </section>
      </div>
    </main>

    <footer class="py-4 text-center text-xs text-slate-500">
      Dane przechowywane lokalnie w przeglądarce.
    </footer>
  </div>

  <!-- Modal nowego wydarzenia -->
  <div id="modal" class="fixed inset-0 z-[100] hidden">
    <div class="absolute inset-0 bg-slate-900/40"></div>
    <div class="absolute inset-0 grid place-items-center p-4">
      <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div class="p-4 flex items-center justify-between border-b border-slate-200">
          <div class="font-semibold">Nowe wydarzenie</div>
          <button id="modalClose" class="px-3 py-1.5 rounded-lg hover:bg-slate-100">✕</button>
        </div>
        <div class="p-4 space-y-3">
          <input id="mTitle" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Tytuł" />
          <div class="grid grid-cols-2 gap-2">
            <input id="mDate" type="date" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" />
            <select id="mCategory" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200"></select>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <select id="mType" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200">
              <option value="timed">Z godzinami</option>
              <option value="allday">Całodniowe</option>
            </select>
            <select id="mRepeat" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200">
              <option value="none">Nie powtarzaj</option>
              <option value="daily">Codziennie</option>
              <option value="weekly">Co tydzień</option>
            </select>
          </div>
          <div id="mTimeFields" class="grid grid-cols-2 gap-2">
            <input id="mStart" type="time" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" />
            <input id="mEnd" type="time" class="px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" />
          </div>
          <textarea id="mNotes" rows="3" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Notatki"></textarea>
          <div class="flex items-center justify-end gap-2">
            <button id="modalCancel" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">Anuluj</button>
            <button id="modalCreate" class="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm">Utwórz</button>
          </div>
          <div class="text-xs text-slate-500">Przeciągnij na siatce w widoku Tydzień/Dzień aby szybko utworzyć.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Narzędzia
    // ---------------------------
    const pad2 = (n) => String(n).padStart(2,'0');

    function toISODate(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
    }

    function parseISODate(s){
      const [y,m,d] = s.split('-').map(Number);
      return new Date(y, m-1, d);
    }

    function clamp(v, a, b){ return Math.min(b, Math.max(a, v)); }

    function minutesToTime(mins){
      mins = clamp(Math.round(mins), 0, 24*60);
      const h = Math.floor(mins/60);
      const m = mins%60;
      return `${pad2(h)}:${pad2(m)}`;
    }

    function timeToMinutes(t){
      if(!t) return 0;
      const [h,m] = t.split(':').map(Number);
      return h*60 + m;
    }

    function startOfWeek(d, weekStartsOnMonday=true){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      const day = x.getDay();
      const offset = weekStartsOnMonday ? (day === 0 ? -6 : 1 - day) : -day;
      x.setDate(x.getDate() + offset);
      return x;
    }

    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      return x;
    }

    function formatMonthYear(d){
      const months = ['Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec', 'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'];
      return `${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function formatRangeLabel(view, anchor){
      const d = new Date(anchor);
      const days = ['Niedziela', 'Poniedziałek', 'Wtorek', 'Środa', 'Czwartek', 'Piątek', 'Sobota'];
      const months = ['Sty', 'Lut', 'Mar', 'Kwi', 'Maj', 'Cze', 'Lip', 'Sie', 'Wrz', 'Paź', 'Lis', 'Gru'];
      
      if(view === 'month') return formatMonthYear(d);
      if(view === 'day') return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
      
      const s = startOfWeek(d, true);
      const e = addDays(s, 6);
      const sameMonth = s.getMonth() === e.getMonth() && s.getFullYear()===e.getFullYear();
      const left = `${s.getDate()} ${months[s.getMonth()]}`;
      const right = sameMonth ? `${e.getDate()} ${months[e.getMonth()]} ${e.getFullYear()}` 
                             : `${e.getDate()} ${months[e.getMonth()]} ${e.getFullYear()}`;
      return `${left} – ${right}`;
    }

    function uid(){ return Math.random().toString(16).slice(2) + '-' + Date.now().toString(16); }

    function isSameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }

    function saveToLocalStorage(){
      try {
        localStorage.setItem('calendarEvents', JSON.stringify(state.events));
      } catch(e) {
        console.warn('Nie udało się zapisać do localStorage');
      }
    }

    function loadFromLocalStorage(){
      try {
        const saved = localStorage.getItem('calendarEvents');
        if(saved) {
          const parsed = JSON.parse(saved);
          if(Array.isArray(parsed)) {
            return parsed;
          }
        }
      } catch(e) {
        console.warn('Nie udało się wczytać z localStorage');
      }
      return null;
    }

    // ---------------------------
    // Stan
    // ---------------------------
    const state = {
      view: 'week',
      anchorDate: new Date(),
      selectedId: null,
      categories: [
        { id: 'work', name: 'Praca', color: 'bg-blue-600', light: 'bg-blue-50', ring: 'ring-blue-200', text: 'text-blue-700' },
        { id: 'personal', name: 'Osobiste', color: 'bg-emerald-600', light: 'bg-emerald-50', ring: 'ring-emerald-200', text: 'text-emerald-700' },
        { id: 'family', name: 'Rodzina', color: 'bg-amber-500', light: 'bg-amber-50', ring: 'ring-amber-200', text: 'text-amber-800' },
        { id: 'focus', name: 'Skupienie', color: 'bg-violet-600', light: 'bg-violet-50', ring: 'ring-violet-200', text: 'text-violet-700' },
        { id: 'travel', name: 'Podróże', color: 'bg-rose-600', light: 'bg-rose-50', ring: 'ring-rose-200', text: 'text-rose-700' },
      ],
      filters: new Set(['work','personal','family','focus','travel']),
      events: [],
      ui: {
        drag: null,
        ghostEl: null,
        nowTimer: null,
      }
    };

    // Przykładowe wydarzenia
    function seedSampleEvents(){
      const today = new Date();
      const isoToday = toISODate(today);
      const monday = startOfWeek(today, true);

      const make = (dateISO, start, end, title, cat, notes='', type='timed', repeat='none') => ({
        id: uid(),
        title, date: dateISO, start, end, category: cat, notes, type, repeat
      });

      const d1 = toISODate(addDays(monday, 0));
      const d2 = toISODate(addDays(monday, 1));
      const d3 = toISODate(addDays(monday, 2));

      state.events = [
        make(d1, '09:00', '10:15', 'Planowanie tygodnia', 'work', 'Przegląd celów i priorytetów.'),
        make(d1, '13:00', '13:30', 'Spotkanie 1:1 z Samem', 'work'),
        make(d2, '11:00', '12:00', 'Siłownia', 'personal', 'Dzień nóg.'),
        make(d2, '14:30', '16:00', 'Przegląd projektu', 'work'),
        make(isoToday, '00:00', '23:59', 'Urodziny żony', 'family', '', 'allday'),
        make(isoToday, '19:00', '20:00', 'Telefon do rodziców', 'family'),
      ];
    }

    // ---------------------------
    // Referencje DOM
    // ---------------------------
    const els = {
      calendarRoot: document.getElementById('calendarRoot'),
      rangeLabel: document.getElementById('rangeLabel'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      todayBtn: document.getElementById('todayBtn'),
      viewBtns: Array.from(document.querySelectorAll('.viewBtn')),
      newBtn: document.getElementById('newBtn'),
      categoryList: document.getElementById('categoryList'),
      resetFilters: document.getElementById('resetFilters'),
      quickTitle: document.getElementById('quickTitle'),
      quickDate: document.getElementById('quickDate'),
      quickTime: document.getElementById('quickTime'),
      quickCategory: document.getElementById('quickCategory'),
      quickType: document.getElementById('quickType'),
      quickAddBtn: document.getElementById('quickAddBtn'),
      
      inspectorEmpty: document.getElementById('inspectorEmpty'),
      inspector: document.getElementById('inspector'),
      insTitle: document.getElementById('insTitle'),
      insDate: document.getElementById('insDate'),
      insStart: document.getElementById('insStart'),
      insEnd: document.getElementById('insEnd'),
      insCategory: document.getElementById('insCategory'),
      insType: document.getElementById('insType'),
      insRepeat: document.getElementById('insRepeat'),
      timeFields: document.getElementById('timeFields'),
      insNotes: document.getElementById('insNotes'),
      saveBtn: document.getElementById('saveBtn'),
      deleteBtn: document.getElementById('deleteBtn'),
      
      searchInput: document.getElementById('searchInput'),
      searchResults: document.getElementById('searchResults'),
      
      modal: document.getElementById('modal'),
      modalClose: document.getElementById('modalClose'),
      modalCancel: document.getElementById('modalCancel'),
      modalCreate: document.getElementById('modalCreate'),
      mTitle: document.getElementById('mTitle'),
      mDate: document.getElementById('mDate'),
      mStart: document.getElementById('mStart'),
      mEnd: document.getElementById('mEnd'),
      mCategory: document.getElementById('mCategory'),
      mType: document.getElementById('mType'),
      mTimeFields: document.getElementById('mTimeFields'),
      mRepeat: document.getElementById('mRepeat'),
      mNotes: document.getElementById('mNotes'),
    };

    // ---------------------------
    // Renderowanie
    // ---------------------------
    function setView(view){
      state.view = view;
      state.selectedId = null;
      render();
    }

    function moveAnchor(delta){
      const d = new Date(state.anchorDate);
      if(state.view === 'month') d.setMonth(d.getMonth()+delta);
      else if(state.view === 'week') d.setDate(d.getDate() + delta*7);
      else d.setDate(d.getDate()+delta);
      state.anchorDate = d;
      render();
    }

    function renderMonthView(root){
      const d = new Date(state.anchorDate);
      const first = new Date(d.getFullYear(), d.getMonth(), 1);
      const start = startOfWeek(first, true);
      const days = [];
      for(let i=0;i<42;i++) days.push(addDays(start, i));

      const header = document.createElement('div');
      header.className = 'grid grid-cols-7 border-b border-slate-200 bg-slate-50';
      const names = ['Pn', 'Wt', 'Śr', 'Czw', 'Pt', 'Sb', 'Nd'];
      for(const n of names){
        const h = document.createElement('div');
        h.className = 'px-3 py-2 text-xs font-semibold text-slate-600 text-center';
        h.textContent = n;
        header.appendChild(h);
      }

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-7';

      const today = new Date();
      const month = d.getMonth();
      const evs = filteredEvents();

      for(const day of days){
        const iso = toISODate(day);
        const isThisMonth = day.getMonth()===month;
        const cell = document.createElement('div');
        cell.className = `month-cell border-b border-slate-200 border-r border-slate-200 p-2 ${isThisMonth?'bg-white':'bg-slate-50/60'} ${isSameDay(day,today)?'ring-inset ring-2 ring-blue-300':''}`;

        const dayNum = document.createElement('div');
        dayNum.className = 'absolute top-2 left-2 text-xs font-semibold';
        dayNum.innerHTML = isSameDay(day,today)
          ? `<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 text-white">${day.getDate()}</span>`
          : `<span class="text-slate-700 ${isThisMonth?'':'opacity-60'}">${day.getDate()}</span>`;

        const eventsWrap = document.createElement('div');
        eventsWrap.className = 'month-events';

        const todays = evs.filter(e=>e.date===iso).sort((a,b)=> timeToMinutes(a.start)-timeToMinutes(b.start));
        const maxToShow = 4;
        const show = todays.slice(0,maxToShow);
        for(const ev of show){
          const cat = categoryById(ev.category);
          const pill = document.createElement('button');
          pill.className = `month-pill ${cat.light} ${cat.text} border border-slate-200 hover:brightness-95 text-left`;
          pill.textContent = ev.type === 'allday' ? ev.title : `${ev.start} ${ev.title}`;
          pill.title = `${ev.title} ${ev.type === 'timed' ? `(${ev.start}-${ev.end})` : '(całodniowe)'}`;
          pill.addEventListener('click', ()=>{ selectEvent(ev.id); });
          eventsWrap.appendChild(pill);
        }
        if(todays.length>maxToShow){
          const more = document.createElement('div');
          more.className='text-xs text-slate-500 px-1';
          more.textContent = `+${todays.length-maxToShow} więcej`;
          eventsWrap.appendChild(more);
        }

        cell.addEventListener('dblclick', (e)=>{
          state.anchorDate = day;
          setView('day');
        });

        cell.appendChild(dayNum);
        cell.appendChild(eventsWrap);
        grid.appendChild(cell);
      }

      Array.from(grid.children).forEach((c,i)=>{
        if((i+1)%7===0) c.classList.remove('border-r');
      });

      root.appendChild(header);
      root.appendChild(grid);
      renderInspector();
    }

    function renderWeekView(root){
      const start = startOfWeek(state.anchorDate, true);
      const days = Array.from({length:7}, (_,i)=> addDays(start, i));
      const container = document.createElement('div');
      container.className = 'w-full';

      // Nagłówek z dniami
      const header = document.createElement('div');
      header.className = 'grid border-b border-slate-200 bg-white';
      header.style.gridTemplateColumns = `${getComputedStyle(document.documentElement).getPropertyValue('--cal-gutter')} repeat(${days.length}, minmax(var(--cal-day-min-width), 1fr))`;

      const gutter = document.createElement('div');
      gutter.className = 'px-3 py-2 text-xs font-semibold text-slate-600 bg-slate-50 border-r border-slate-200';
      header.appendChild(gutter);

      const today = new Date();
      const dayNames = ['Pn', 'Wt', 'Śr', 'Czw', 'Pt', 'Sb', 'Nd'];
      const monthNames = ['Sty', 'Lut', 'Mar', 'Kwi', 'Maj', 'Cze', 'Lip', 'Sie', 'Wrz', 'Paź', 'Lis', 'Gru'];
      
      for(let i = 0; i < days.length; i++){
        const day = days[i];
        const isToday = isSameDay(day, today);
        const col = document.createElement('div');
        col.className = `px-3 py-2 text-xs border-r border-slate-200 ${isToday?'bg-blue-50':''}`;
        col.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold text-slate-600">${dayNames[i]}</div>
            <div class="text-slate-500">${day.getDate()} ${monthNames[day.getMonth()]}</div>
          </div>
          <div class="mt-1">
            ${isToday ? `<span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-blue-600 text-white text-xs">${day.getDate()}</span>` 
                      : `<span class="text-slate-900">${day.getDate()}</span>`}
          </div>
        `;
        header.appendChild(col);
      }
      header.lastElementChild?.classList.remove('border-r');
      container.appendChild(header);

      // Główna siatka
      const wrapper = document.createElement('div');
      wrapper.className = 'relative overflow-auto thin-scroll';
      wrapper.style.height = 'calc(100dvh - 220px)';

      const grid = document.createElement('div');
      grid.className = 'grid';
      grid.style.gridTemplateColumns = `${getComputedStyle(document.documentElement).getPropertyValue('--cal-gutter')} repeat(${days.length}, minmax(var(--cal-day-min-width), 1fr))`;

      // Lewa kolumna z godzinami
      const timeCol = document.createElement('div');
      timeCol.className = 'relative bg-slate-50 border-r border-slate-200';
      timeCol.style.height = `calc(var(--cal-hour-height) * 24)`;

      for(let h=0; h<24; h++){
        const t = document.createElement('div');
        t.className = 'absolute left-0 right-0 text-[11px] text-slate-500 pr-2';
        t.style.top = `calc(var(--cal-hour-height) * ${h})`;
        t.style.transform = 'translateY(-50%)';
        t.style.textAlign = 'right';
        t.textContent = h===0 ? '' : `${h}:00`;
        timeCol.appendChild(t);
      }
      grid.appendChild(timeCol);

      // Kolumny z dniami
      const evs = filteredEvents();
      for(const day of days){
        const iso = toISODate(day);
        const col = document.createElement('div');
        col.className = `relative border-r border-slate-200 ${isSameDay(day,today)?'bg-blue-50/30':''}`;

        const timeGrid = document.createElement('div');
        timeGrid.className = 'time-grid relative';
        timeGrid.style.height = `calc(var(--cal-hour-height) * 24)`;
        timeGrid.dataset.date = iso;
        timeGrid.addEventListener('mousedown', (e)=> beginCreateDrag(e, timeGrid));

        // Wydarzenia całodniowe na górze
        const alldays = evs.filter(e=>e.date===iso && e.type==='allday');
        const alldayContainer = document.createElement('div');
        alldayContainer.className = 'absolute top-0 left-0 right-0 h-8 border-b border-slate-200 bg-slate-50';
        
        alldays.forEach((ev, idx) => {
          const alldayEl = document.createElement('div');
          alldayEl.className = `allday-event ${categoryById(ev.category).color} text-white`;
          alldayEl.textContent = ev.title;
          alldayEl.title = ev.title;
          alldayEl.style.top = `${2 + idx * 26}px`;
          alldayEl.addEventListener('click', (e)=>{ e.stopPropagation(); selectEvent(ev.id); });
          timeGrid.appendChild(alldayEl);
        });

        // Wydarzenia z godzinami
        const timed = evs.filter(e=>e.date===iso && e.type==='timed').map(e=>({ ...e, startMin: timeToMinutes(e.start), endMin: timeToMinutes(e.end) }));
        
        timed.forEach(ev => {
          const cat = categoryById(ev.category);
          const block = document.createElement('div');
          block.className = `event ${cat.color} text-white`;
          block.dataset.eventId = ev.id;
          block.style.top = `calc(var(--cal-hour-height) * ${ev.startMin/60})`;
          block.style.height = `calc(var(--cal-hour-height) * ${Math.max(0.25, (ev.endMin-ev.startMin)/60)})`;
          block.style.left = '6px';
          block.style.right = '6px';

          block.innerHTML = `
            <div class="title truncate">${escapeHtml(ev.title)}</div>
            <div class="meta truncate">${ev.start}–${ev.end}</div>
            <div class="resize-handle bg-black"></div>
          `;

          block.addEventListener('mousedown', (e)=> beginMoveDrag(e, block));
          block.addEventListener('click', (e)=>{ e.stopPropagation(); selectEvent(ev.id); });

          const handle = block.querySelector('.resize-handle');
          handle.addEventListener('mousedown', (e)=> beginResizeDrag(e, block));

          timeGrid.appendChild(block);
        });

        // Wskaźnik bieżącego czasu
        if(isSameDay(day, today)){
          const nowLine = document.createElement('div');
          nowLine.className = 'now-line';
          nowLine.dataset.nowLine = '1';
          const nowDot = document.createElement('div');
          nowDot.className = 'now-dot';
          nowDot.dataset.nowDot = '1';
          timeGrid.appendChild(nowLine);
          timeGrid.appendChild(nowDot);
        }

        col.appendChild(timeGrid);
        grid.appendChild(col);
      }

      grid.lastElementChild?.classList.remove('border-r');
      wrapper.appendChild(grid);
      container.appendChild(wrapper);
      root.appendChild(container);
      
      // Przewiń do 8:00
      requestAnimationFrame(()=>{
        wrapper.scrollTop = (8 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cal-hour-height'))) - 40;
        updateNowIndicator(container);
      });

      if(state.ui.nowTimer) clearInterval(state.ui.nowTimer);
      state.ui.nowTimer = setInterval(()=> updateNowIndicator(container), 30*1000);
      
      renderInspector();
    }

    function renderDayView(root){
      const day = new Date(state.anchorDate);
      day.setHours(0,0,0,0);
      const days = [day];
      const container = document.createElement('div');
      container.className = 'w-full';

      // Nagłówek
      const header = document.createElement('div');
      header.className = 'grid border-b border-slate-200 bg-white';
      header.style.gridTemplateColumns = `${getComputedStyle(document.documentElement).getPropertyValue('--cal-gutter')} minmax(var(--cal-day-min-width), 1fr)`;

      const gutter = document.createElement('div');
      gutter.className = 'px-3 py-2 text-xs font-semibold text-slate-600 bg-slate-50 border-r border-slate-200';
      header.appendChild(gutter);

      const today = new Date();
      const isToday = isSameDay(day, today);
      const dayNames = ['Niedziela', 'Poniedziałek', 'Wtorek', 'Środa', 'Czwartek', 'Piątek', 'Sobota'];
      const monthNames = ['Stycznia', 'Lutego', 'Marca', 'Kwietnia', 'Maja', 'Czerwca', 'Lipca', 'Sierpnia', 'Września', 'Października', 'Listopada', 'Grudnia'];
      
      const col = document.createElement('div');
      col.className = `px-3 py-2 text-sm border-r border-slate-200 ${isToday?'bg-blue-50':''}`;
      col.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="font-semibold text-slate-900">${dayNames[day.getDay()]}</div>
          <div class="text-slate-600">${day.getDate()} ${monthNames[day.getMonth()]} ${day.getFullYear()}</div>
        </div>
        ${isToday ? '<div class="mt-1 text-xs text-blue-600">Dzisiaj</div>' : ''}
      `;
      header.appendChild(col);
      container.appendChild(header);

      // Siatka
      const wrapper = document.createElement('div');
      wrapper.className = 'relative overflow-auto thin-scroll';
      wrapper.style.height = 'calc(100dvh - 220px)';

      const grid = document.createElement('div');
      grid.className = 'grid';
      grid.style.gridTemplateColumns = `${getComputedStyle(document.documentElement).getPropertyValue('--cal-gutter')} minmax(var(--cal-day-min-width), 1fr)`;

      // Godziny
      const timeCol = document.createElement('div');
      timeCol.className = 'relative bg-slate-50 border-r border-slate-200';
      timeCol.style.height = `calc(var(--cal-hour-height) * 24)`;

      for(let h=0; h<24; h++){
        const t = document.createElement('div');
        t.className = 'absolute left-0 right-0 text-[11px] text-slate-500 pr-2';
        t.style.top = `calc(var(--cal-hour-height) * ${h})`;
        t.style.transform = 'translateY(-50%)';
        t.style.textAlign = 'right';
        t.textContent = h===0 ? '0:00' : `${h}:00`;
        timeCol.appendChild(t);
        
        if(h < 23){
          const half = document.createElement('div');
          half.className = 'absolute left-0 right-0 text-[10px] text-slate-400 pr-2';
          half.style.top = `calc(var(--cal-hour-height) * ${h + 0.5})`;
          half.style.transform = 'translateY(-50%)';
          half.style.textAlign = 'right';
          half.textContent = `${h}:30`;
          timeCol.appendChild(half);
        }
      }
      grid.appendChild(timeCol);

      // Główna kolumna
      const mainCol = document.createElement('div');
      mainCol.className = `relative border-r border-slate-200 ${isToday?'bg-blue-50/30':''}`;
      const iso = toISODate(day);
      
      const timeGrid = document.createElement('div');
      timeGrid.className = 'time-grid relative';
      timeGrid.style.height = `calc(var(--cal-hour-height) * 24)`;
      timeGrid.dataset.date = iso;
      timeGrid.addEventListener('mousedown', (e)=> beginCreateDrag(e, timeGrid));

      // Wydarzenia
      const evs = filteredEvents().filter(e=>e.date===iso);
      evs.forEach(ev => {
        const cat = categoryById(ev.category);
        if(ev.type === 'allday'){
          const alldayEl = document.createElement('div');
          alldayEl.className = `allday-event ${cat.color} text-white`;
          alldayEl.textContent = ev.title;
          alldayEl.title = ev.title;
          alldayEl.style.top = '2px';
          alldayEl.addEventListener('click', (e)=>{ e.stopPropagation(); selectEvent(ev.id); });
          timeGrid.appendChild(alldayEl);
        } else {
          const startMin = timeToMinutes(ev.start);
          const endMin = timeToMinutes(ev.end);
          const block = document.createElement('div');
          block.className = `event ${cat.color} text-white`;
          block.dataset.eventId = ev.id;
          block.style.top = `calc(var(--cal-hour-height) * ${startMin/60})`;
          block.style.height = `calc(var(--cal-hour-height) * ${Math.max(0.25, (endMin-startMin)/60)})`;
          block.style.left = '6px';
          block.style.right = '6px';

          block.innerHTML = `
            <div class="title truncate">${escapeHtml(ev.title)}</div>
            <div class="meta truncate">${ev.start}–${ev.end}</div>
            <div class="resize-handle bg-black"></div>
          `;

          block.addEventListener('mousedown', (e)=> beginMoveDrag(e, block));
          block.addEventListener('click', (e)=>{ e.stopPropagation(); selectEvent(ev.id); });

          const handle = block.querySelector('.resize-handle');
          handle.addEventListener('mousedown', (e)=> beginResizeDrag(e, block));

          timeGrid.appendChild(block);
        }
      });

      // Wskaźnik czasu
      if(isToday){
        const nowLine = document.createElement('div');
        nowLine.className = 'now-line';
        nowLine.dataset.nowLine = '1';
        const nowDot = document.createElement('div');
        nowDot.className = 'now-dot';
        nowDot.dataset.nowDot = '1';
        timeGrid.appendChild(nowLine);
        timeGrid.appendChild(nowDot);
      }

      mainCol.appendChild(timeGrid);
      grid.appendChild(mainCol);
      wrapper.appendChild(grid);
      container.appendChild(wrapper);
      root.appendChild(container);
      
      requestAnimationFrame(()=>{
        const now = new Date();
        const currentHour = now.getHours();
        wrapper.scrollTop = (currentHour * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cal-hour-height'))) - 100;
        updateNowIndicator(container);
      });

      if(state.ui.nowTimer) clearInterval(state.ui.nowTimer);
      state.ui.nowTimer = setInterval(()=> updateNowIndicator(container), 30*1000);
      
      renderInspector();
    }

    function renderListView(root){
      const container = document.createElement('div');
      container.className = 'p-4';
      
      const header = document.createElement('div');
      header.className = 'mb-4 pb-2 border-b border-slate-200';
      header.innerHTML = '<h2 class="text-lg font-semibold">Lista wydarzeń</h2>';
      container.appendChild(header);

      const events = filteredEvents()
        .sort((a,b) => {
          const dateComp = new Date(a.date) - new Date(b.date);
          if(dateComp !== 0) return dateComp;
          return timeToMinutes(a.start) - timeToMinutes(b.start);
        });

      if(events.length === 0){
        const empty = document.createElement('div');
        empty.className = 'text-center py-8 text-slate-500';
        empty.textContent = 'Brak wydarzeń';
        container.appendChild(empty);
      } else {
        const list = document.createElement('div');
        list.className = 'space-y-2';
        
        events.forEach(ev => {
          const item = document.createElement('div');
          item.className = 'p-3 border border-slate-200 rounded-xl hover:bg-slate-50 cursor-pointer';
          item.addEventListener('click', () => selectEvent(ev.id));
          
          const cat = categoryById(ev.category);
          const date = new Date(ev.date);
          const dayNames = ['Nd', 'Pn', 'Wt', 'Śr', 'Czw', 'Pt', 'Sb'];
          
          item.innerHTML = `
            <div class="flex items-start gap-3">
              <div class="w-2 h-2 mt-1.5 rounded-full ${cat.color}"></div>
              <div class="flex-1">
                <div class="font-medium">${escapeHtml(ev.title)}</div>
                <div class="text-sm text-slate-600 mt-1">
                  ${dayNames[date.getDay()]}, ${date.getDate()} ${date.toLocaleDateString('pl-PL', {month: 'short'})}
                  ${ev.type === 'timed' ? ` • ${ev.start}-${ev.end}` : ' • Całodniowe'}
                </div>
                ${ev.notes ? `<div class="text-sm text-slate-500 mt-1">${escapeHtml(ev.notes)}</div>` : ''}
              </div>
              <div class="text-xs text-slate-500">${cat.name}</div>
            </div>
          `;
          list.appendChild(item);
        });
        container.appendChild(list);
      }
      
      root.appendChild(container);
      renderInspector();
    }

    function updateNowIndicator(container){
      const now = new Date();
      const mins = now.getHours()*60 + now.getMinutes();
      const top = `calc(var(--cal-hour-height) * ${mins/60})`;
      container.querySelectorAll('[data-now-line="1"]').forEach(el=>{ el.style.top = top; });
      container.querySelectorAll('[data-now-dot="1"]').forEach(el=>{ el.style.top = top; });
    }

    function render(){
      updateRangeLabel();
      els.viewBtns.forEach(b=>{
        const active = b.dataset.view === state.view;
        b.classList.toggle('bg-slate-900', active);
        b.classList.toggle('text-white', active);
        b.classList.toggle('bg-white', !active);
      });

      renderCategories();
      els.calendarRoot.innerHTML = '';
      
      switch(state.view){
        case 'month': renderMonthView(els.calendarRoot); break;
        case 'week': renderWeekView(els.calendarRoot); break;
        case 'day': renderDayView(els.calendarRoot); break;
        case 'list': renderListView(els.calendarRoot); break;
      }

      if(state.selectedId){
        const el = document.querySelector(`[data-event-id="${CSS.escape(state.selectedId)}"]`);
        if(el) el.classList.add('ring-2','ring-blue-300');
      }
      
      performSearch();
    }

    function renderCategories(){
      els.categoryList.innerHTML = '';
      state.categories.forEach(c => {
        const count = state.events.filter(e=>e.category===c.id).length;
        const row = document.createElement('label');
        row.className = 'flex items-center gap-3 px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 cursor-pointer';
        row.innerHTML = `
          <input type="checkbox" class="h-4 w-4" ${state.filters.has(c.id)?'checked':''} data-cat="${c.id}" />
          <span class="w-3 h-3 rounded-full ${c.color}"></span>
          <span class="text-sm flex-1">${c.name}</span>
          <span class="text-xs text-slate-500">${count}</span>
        `;
        els.categoryList.appendChild(row);
      });

      const options = state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      els.quickCategory.innerHTML = options;
      els.insCategory.innerHTML = options;
      els.mCategory.innerHTML = options;
    }

    function renderInspector(){
      const ev = state.events.find(e=>e.id===state.selectedId);
      if(!ev){
        els.inspector.classList.add('hidden');
        els.inspectorEmpty.classList.remove('hidden');
        return;
      }
      
      els.inspectorEmpty.classList.add('hidden');
      els.inspector.classList.remove('hidden');
      els.insTitle.value = ev.title;
      els.insDate.value = ev.date;
      els.insType.value = ev.type || 'timed';
      els.insRepeat.value = ev.repeat || 'none';
      els.insCategory.value = ev.category;
      els.insNotes.value = ev.notes || '';
      
      if(ev.type === 'allday'){
        els.timeFields.classList.add('hidden');
        els.insStart.value = '';
        els.insEnd.value = '';
      } else {
        els.timeFields.classList.remove('hidden');
        els.insStart.value = ev.start;
        els.insEnd.value = ev.end;
      }
    }

    function performSearch(){
      const query = els.searchInput.value.toLowerCase().trim();
      if(!query){
        els.searchResults.innerHTML = '<div class="text-sm text-slate-500">Wpisz aby wyszukać</div>';
        return;
      }
      
      const results = state.events.filter(ev => 
        ev.title.toLowerCase().includes(query) || 
        ev.notes.toLowerCase().includes(query) ||
        ev.category.toLowerCase().includes(query)
      ).slice(0, 10);
      
      if(results.length === 0){
        els.searchResults.innerHTML = '<div class="text-sm text-slate-500">Brak wyników</div>';
        return;
      }
      
      let html = '';
      results.forEach(ev => {
        const cat = categoryById(ev.category);
        const date = new Date(ev.date);
        html += `
          <div class="p-2 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer" 
               onclick="selectEvent('${ev.id}'); state.view='day'; state.anchorDate=new Date('${ev.date}'); render();">
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 rounded-full ${cat.color}"></div>
              <div class="text-sm font-medium truncate">${escapeHtml(ev.title)}</div>
            </div>
            <div class="text-xs text-slate-600 mt-1">
              ${date.toLocaleDateString('pl-PL')} ${ev.type === 'timed' ? `${ev.start}-${ev.end}` : 'całodniowe'}
            </div>
          </div>
        `;
      });
      
      els.searchResults.innerHTML = html;
    }

    // ---------------------------
    // Operacje na wydarzeniach
    // ---------------------------
    function createEvent(data){
      const startMin = timeToMinutes(data.start);
      const endMin = timeToMinutes(data.end);
      const fixedEnd = endMin <= startMin ? startMin + 30 : endMin;
      
      const ev = {
        id: uid(),
        title: data.title?.trim() || 'Bez nazwy',
        date: data.date,
        start: data.type === 'allday' ? '00:00' : data.start,
        end: data.type === 'allday' ? '23:59' : minutesToTime(fixedEnd),
        category: data.category,
        notes: data.notes || '',
        type: data.type || 'timed',
        repeat: data.repeat || 'none'
      };
      
      state.events.push(ev);
      state.selectedId = ev.id;
      saveToLocalStorage();
      render();
    }

    function saveInspector(){
      const ev = state.events.find(e=>e.id===state.selectedId);
      if(!ev) return;
      
      ev.title = els.insTitle.value.trim() || 'Bez nazwy';
      ev.date = els.insDate.value;
      ev.type = els.insType.value;
      ev.repeat = els.insRepeat.value;
      ev.category = els.insCategory.value;
      ev.notes = els.insNotes.value;
      
      if(ev.type === 'timed'){
        ev.start = els.insStart.value;
        ev.end = els.insEnd.value;
        const s = timeToMinutes(ev.start);
        const e = timeToMinutes(ev.end);
        if(e <= s) ev.end = minutesToTime(s+30);
      } else {
        ev.start = '00:00';
        ev.end = '23:59';
      }
      
      saveToLocalStorage();
      render();
    }

    function deleteSelected(){
      const id = state.selectedId;
      if(!id) return;
      state.events = state.events.filter(e=>e.id!==id);
      state.selectedId = null;
      saveToLocalStorage();
      render();
      renderInspector();
    }

    // ---------------------------
    // Przeciąganie
    // ---------------------------
    function beginCreateDrag(e, timeGridEl){
      if(e.button !== 0) return;
      if(e.target.closest('.event')) return;

      state.selectedId = null;
      renderInspector();

      const date = timeGridEl.dataset.date;
      const startMin = pxToMinutes(timeGridEl, e.clientY);
      const g = ensureGhost(timeGridEl);

      state.ui.drag = {
        type: 'create',
        date,
        timeGridEl,
        startMin,
        currentMin: startMin,
      };

      document.body.classList.add('no-select');
      updateCreateGhost();

      window.addEventListener('mousemove', onDragMove);
      window.addEventListener('mouseup', onDragEnd);
      window.addEventListener('keydown', onKeyCancelOnce);
    }

    function beginMoveDrag(e, eventEl){
      if(e.button !== 0) return;
      if(e.target.closest('.resize-handle')) return;
      e.preventDefault();
      e.stopPropagation();

      const id = eventEl.dataset.eventId;
      const ev = state.events.find(x=>x.id===id);
      if(!ev) return;

      selectEvent(id);

      const timeGridEl = eventEl.closest('[data-date]');
      const startMin = timeToMinutes(ev.start);
      const endMin = timeToMinutes(ev.end);
      const pointerMin = pxToMinutes(timeGridEl, e.clientY);
      const offsetMin = pointerMin - startMin;

      state.ui.drag = { 
        type:'move', 
        id, 
        timeGridEl, 
        date: ev.date, 
        offsetMin, 
        durationMin: Math.max(15, endMin-startMin) 
      };
      
      document.body.classList.add('no-select');

      window.addEventListener('mousemove', onDragMove);
      window.addEventListener('mouseup', onDragEnd);
      window.addEventListener('keydown', onKeyCancelOnce);
    }

    function beginResizeDrag(e, eventEl){
      if(e.button !== 0) return;
      e.preventDefault();
      e.stopPropagation();

      const id = eventEl.dataset.eventId;
      const ev = state.events.find(x=>x.id===id);
      if(!ev) return;
      selectEvent(id);

      const timeGridEl = eventEl.closest('[data-date]');
      const startMin = timeToMinutes(ev.start);

      state.ui.drag = { type:'resize', id, timeGridEl, startMin };
      document.body.classList.add('no-select');

      window.addEventListener('mousemove', onDragMove);
      window.addEventListener('mouseup', onDragEnd);
      window.addEventListener('keydown', onKeyCancelOnce);
    }

    function pxToMinutes(timeGridEl, clientY){
      const rect = timeGridEl.getBoundingClientRect();
      const y = clamp(clientY - rect.top, 0, rect.height);
      const hourHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cal-hour-height'));
      const mins = (y / hourHeight) * 60;
      return Math.round(mins / 15) * 15;
    }

    function ensureGhost(container){
      if(state.ui.ghostEl && state.ui.ghostEl.isConnected) return state.ui.ghostEl;
      const g = document.createElement('div');
      g.className = 'ghost';
      container.appendChild(g);
      state.ui.ghostEl = g;
      return g;
    }

    function removeGhost(){
      if(state.ui.ghostEl && state.ui.ghostEl.isConnected) state.ui.ghostEl.remove();
      state.ui.ghostEl = null;
    }

    function updateCreateGhost(){
      const d = state.ui.drag;
      if(!d || d.type!=='create') return;
      const a = d.startMin;
      const b = d.currentMin;
      const start = Math.min(a,b);
      const end = Math.max(a,b);
      const duration = Math.max(30, end-start);

      const hourHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cal-hour-height'));
      const topPx = (start/60) * hourHeight;
      const heightPx = (duration/60) * hourHeight;

      const g = ensureGhost(d.timeGridEl);
      g.style.left = '6px';
      g.style.right = '6px';
      g.style.top = `${topPx}px`;
      g.style.height = `${heightPx}px`;
    }

    function onDragMove(e){
      const d = state.ui.drag;
      if(!d) return;

      if(d.type==='create'){
        d.currentMin = pxToMinutes(d.timeGridEl, e.clientY);
        updateCreateGhost();
      } else if(d.type==='move'){
        const mins = pxToMinutes(d.timeGridEl, e.clientY);
        const startMin = clamp(mins - d.offsetMin, 0, 24*60-15);
        const endMin = clamp(startMin + d.durationMin, 15, 24*60);
        const ev = state.events.find(x=>x.id===d.id);
        if(ev){
          ev.start = minutesToTime(startMin);
          ev.end = minutesToTime(endMin);
          saveToLocalStorage();
          render();
          selectEvent(d.id);
        }
      } else if(d.type==='resize'){
        const mins = pxToMinutes(d.timeGridEl, e.clientY);
        const endMin = clamp(Math.round(mins/15)*15, d.startMin+15, 24*60);
        const ev = state.events.find(x=>x.id===d.id);
        if(ev){
          ev.end = minutesToTime(endMin);
          saveToLocalStorage();
          render();
          selectEvent(d.id);
        }
      }
    }

    function onDragEnd(e){
      const d = state.ui.drag;
      if(!d) return;

      if(d.type==='create'){
        const a = d.startMin;
        const b = d.currentMin;
        const start = Math.min(a,b);
        const end = Math.max(a,b);
        const duration = Math.max(30, end-start);
        const startT = minutesToTime(start);
        const endT = minutesToTime(start + duration);

        removeGhost();
        state.ui.drag = null;
        document.body.classList.remove('no-select');

        openModal({
          title: 'Nowe wydarzenie',
          date: d.date,
          start: startT,
          end: endT,
          category: state.categories[0].id,
          type: 'timed',
          notes: ''
        });
      } else {
        state.ui.drag = null;
        document.body.classList.remove('no-select');
      }

      window.removeEventListener('mousemove', onDragMove);
      window.removeEventListener('mouseup', onDragEnd);
    }

    function onKeyCancelOnce(e){
      if(e.key === 'Escape'){
        removeGhost();
        state.ui.drag = null;
        document.body.classList.remove('no-select');
        window.removeEventListener('mousemove', onDragMove);
        window.removeEventListener('mouseup', onDragEnd);
        window.removeEventListener('keydown', onKeyCancelOnce);
      }
    }

    // ---------------------------
    // Modal
    // ---------------------------
    function openModal(prefill={}){
      els.modal.classList.remove('hidden');
      const todayISO = toISODate(new Date());
      els.mTitle.value = prefill.title ?? '';
      els.mDate.value = prefill.date ?? todayISO;
      els.mStart.value = prefill.start ?? '09:00';
      els.mEnd.value = prefill.end ?? '10:00';
      els.mCategory.value = prefill.category ?? state.categories[0].id;
      els.mType.value = prefill.type ?? 'timed';
      els.mRepeat.value = prefill.repeat ?? 'none';
      els.mNotes.value = prefill.notes ?? '';
      
      if(prefill.type === 'allday' || prefill.type === undefined){
        els.mTimeFields.classList.add('hidden');
      } else {
        els.mTimeFields.classList.remove('hidden');
      }
      
      setTimeout(()=> els.mTitle.focus(), 0);
    }

    function closeModal(){
      els.modal.classList.add('hidden');
    }

    function selectEvent(id){
      state.selectedId = id;
      renderInspector();
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // ---------------------------
    // Inicjalizacja
    // ---------------------------
    function wire(){
      // Nawigacja
      els.prevBtn.addEventListener('click', ()=> moveAnchor(-1));
      els.nextBtn.addEventListener('click', ()=> moveAnchor(1));
      els.todayBtn.addEventListener('click', ()=>{ 
        state.anchorDate = new Date(); 
        render(); 
      });

      // Widoki
      els.viewBtns.forEach(b=> b.addEventListener('click', ()=> setView(b.dataset.view)));

      // Nowe wydarzenie
      els.newBtn.addEventListener('click', ()=> openModal({ 
        date: toISODate(state.anchorDate) 
      }));

      // Filtry
      els.resetFilters.addEventListener('click', ()=>{ 
        state.filters = new Set(state.categories.map(c=>c.id)); 
        render(); 
      });

      els.categoryList.addEventListener('change', (e)=>{
        const cb = e.target.closest('input[type="checkbox"][data-cat]');
        if(!cb) return;
        const cat = cb.dataset.cat;
        if(cb.checked) state.filters.add(cat);
        else state.filters.delete(cat);
        render();
      });

      // Szybkie dodawanie
      els.quickDate.value = toISODate(new Date());
      els.quickTime.value = '09:00';
      els.quickAddBtn.addEventListener('click', ()=>{
        const title = els.quickTitle.value.trim();
        const date = els.quickDate.value || toISODate(new Date());
        const type = els.quickType.value;
        const category = els.quickCategory.value;
        
        if(!title){ 
          els.quickTitle.focus(); 
          return; 
        }
        
        let start, end;
        if(type === 'allday'){
          start = '00:00';
          end = '23:59';
        } else {
          start = els.quickTime.value || '09:00';
          const startMin = timeToMinutes(start);
          end = minutesToTime(startMin + 60);
        }
        
        createEvent({ 
          title, 
          date, 
          start, 
          end, 
          category, 
          type,
          notes: '' 
        });
        
        els.quickTitle.value = '';
      });

      // Typ wydarzenia - pokaż/ukryj pola czasu
      els.insType.addEventListener('change', function(){
        if(this.value === 'allday'){
          els.timeFields.classList.add('hidden');
        } else {
          els.timeFields.classList.remove('hidden');
        }
      });
      
      els.mType.addEventListener('change', function(){
        if(this.value === 'allday'){
          els.mTimeFields.classList.add('hidden');
        } else {
          els.mTimeFields.classList.remove('hidden');
        }
      });

      // Edycja
      els.saveBtn.addEventListener('click', saveInspector);
      els.deleteBtn.addEventListener('click', deleteSelected);

      // Wyszukiwanie
      els.searchInput.addEventListener('input', performSearch);

      // Modal
      els.modalClose.addEventListener('click', closeModal);
      els.modalCancel.addEventListener('click', closeModal);
      els.modal.addEventListener('click', (e)=>{ 
        if(e.target === els.modal) closeModal(); 
      });
      
      els.modalCreate.addEventListener('click', ()=>{
        createEvent({
          title: els.mTitle.value,
          date: els.mDate.value,
          start: els.mStart.value,
          end: els.mEnd.value,
          category: els.mCategory.value,
          type: els.mType.value,
          repeat: els.mRepeat.value,
          notes: els.mNotes.value
        });
        closeModal();
      });

      // Klawiatura
      window.addEventListener('keydown', (e)=>{
        const tag = document.activeElement?.tagName?.toLowerCase();
        const inInput = ['input','textarea','select'].includes(tag);
        if(inInput) return;
        
        if((e.key === 'Backspace' || e.key === 'Delete') && state.selectedId){
          e.preventDefault();
          deleteSelected();
        }
      });
    }

    // Start
    const savedEvents = loadFromLocalStorage();
    if(savedEvents && savedEvents.length > 0){
      state.events = savedEvents;
    } else {
      seedSampleEvents();
    }
    
    wire();
    render();
    
    // Aktualizuj wskaźnik czasu co minutę
    setInterval(() => {
      if(state.view === 'week' || state.view === 'day'){
        const now = new Date();
        const container = els.calendarRoot;
        if(container) updateNowIndicator(container);
      }
    }, 60000);
  </script>
</body>
</html>
